# Development Dockerfile for backend
FROM oven/bun:latest

# Install netcat, wget, and procps for MongoDB connectivity, health checks, and process management
RUN apt-get update && apt-get install -y netcat-openbsd wget procps && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy workspace root files first
COPY bun.lock package.json tsconfig.json ./

# Copy all workspace packages
COPY backend ./backend/
COPY shared ./shared/
COPY frontend ./frontend/

# Install dependencies from workspace root
RUN bun install

# Generate Prisma client
RUN cd backend && bunx prisma generate

# Environment variables for development
ENV NODE_ENV=development
ENV PORT=5001
ENV HOST=0.0.0.0

# Expose port
EXPOSE 5001

# Health check for Docker Compose
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD wget --quiet --tries=1 --timeout=5 --spider http://localhost:5001/health || exit 1

# Start the application in development mode from backend directory
CMD ["bun", "--cwd", "backend", "run", "dev"]
